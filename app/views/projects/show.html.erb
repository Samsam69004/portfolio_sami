<%# ================== SEO (head) ================== %>
<%# titre & descriptions spécifiques à la page projet %>
<% content_for :title,            @page_title %>
<% content_for :meta_description, @page_description %>
<% content_for :og_title,         @page_title %>
<% content_for :og_description,   @page_description %>

<%# Données structurées : le projet + le fil d’Ariane %>
<% content_for :structured_data do %>
  <script type="application/ld+json">
    <%= [
      {
        "@context": "https://schema.org",
        "@type": "CreativeWork",
        "name": @project.title,
        "description": @page_description,
        "url": project_url(@project),
        "image": (@og_image.present? ? image_url(@og_image) : image_url("og/default.jpg")),
        "author": { "@type": "Person", "name": "Sami Chabane", "url": "https://samichabane.com" },
        "keywords": @project.techs.to_s.split(",").map(&:strip).join(", ")
      },
      {
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": [
          { "@type": "ListItem", "position": 1, "name": "Accueil",  "item": root_url },
          { "@type": "ListItem", "position": 2, "name": "Projets",  "item": root_url(anchor: "projects") },
          { "@type": "ListItem", "position": 3, "name": @project.title, "item": project_url(@project) }
        ]
      }
    ].to_json.html_safe %>
  </script>
<% end %>

<%# ================== Page ================== %>
<section class="max-w-5xl mx-auto px-4 sm:px-6 py-10">
  <%= link_to "← Retour", projects_path, class: "text-sky-700 hover:underline" %>

  <h1 class="mt-4 text-4xl md:text-5xl font-black tracking-tight">
    <%= @project.title %>
  </h1>

  <% if @project.subtitle.present? %>
    <p class="mt-2 text-lg text-slate-600"><%= @project.subtitle %></p>
  <% end %>

  <!-- Hero 16:9 -->
  <div class="mt-6 overflow-hidden rounded-2xl ring-1 ring-slate-200 bg-slate-100">
    <img
      src="<%= project_image_src(@project) %>"
      alt="<%= @project.title %>"
      width="1280" height="720"
      class="w-full h-auto object-cover">
  </div>

  <% if @project.description.present? %>
    <div class="prose prose-slate max-w-none mt-8">
      <%= simple_format @project.description %>
    </div>
  <% end %>

  <div class="mt-6 flex flex-wrap items-center gap-3">
    <% @project.techs.to_s.split(",").map(&:strip).each do |t| %>
      <span class="inline-flex items-center rounded-full bg-slate-100 px-3 py-1 text-sm text-slate-700 ring-1 ring-slate-200"><%= t %></span>
    <% end %>

    <% if @project.url.present? %>
      <%= link_to "Voir le site",
              @project.url,
              target: "_blank",
              rel: "noopener",
              class: "ml-auto inline-flex items-center rounded-xl bg-sky-500 px-4 py-2.5 text-white font-semibold shadow hover:bg-sky-600 transition" %>
    <% end %>

  </div>

  <%# --------- CAROUSEL --------- %>
  <% images = project_image_list(@project).presence || [project_image_src(@project)] %>

  <div id="carousel-<%= @project.slug %>"
       class="relative w-full max-w-3xl mx-auto mt-8 select-none"
       aria-roledescription="carousel">
    <div class="relative h-80 overflow-hidden rounded-2xl ring-1 ring-slate-200 bg-white">
      <% images.each_with_index do |src, i| %>
        <img
          src="<%= src %>"
          alt="<%= @project.title %> — visuel <%= i + 1 %> sur <%= images.size %>"
          class="carousel-slide <%= i.zero? ? '' : 'hidden' %> w-full h-80 object-contain mx-auto"
          data-index="<%= i %>">
      <% end %>
    </div>

    <!-- Contrôles -->
    <button type="button"
            class="absolute left-0 top-1/2 -translate-y-1/2 px-3 py-2 text-3xl"
            aria-label="Image précédente"
            data-action="prev">‹</button>
    <button type="button"
            class="absolute right-0 top-1/2 -translate-y-1/2 px-3 py-2 text-3xl"
            aria-label="Image suivante"
            data-action="next">›</button>

    <!-- Indicateurs -->
    <div class="mt-3 flex justify-center gap-2">
      <% images.each_with_index do |_, i| %>
        <button type="button"
                class="carousel-dot h-2.5 w-2.5 rounded-full <%= i.zero? ? 'bg-slate-900' : 'bg-slate-300' %>"
                aria-label="Aller à l’image <%= i + 1 %>"
                data-goto="<%= i %>"></button>
      <% end %>
    </div>
  </div>
</section>
